<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>운영자 승인 | LabWave</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="topic-page">
  <div class="bg" aria-hidden="true">
    <div class="stars"></div>
    <div class="stars stars2"></div>
    <div class="glow"></div>
  </div>

  <header class="navbar">
    <div class="container nav-inner">
      <a class="brand" href="index.html">
        <div class="brand-mark">L</div>
        <div class="brand-name">LabWave</div>
      </a>
      <div class="nav-actions">
        <a class="btn btn-ghost btn-sm" href="profile.html">프로필</a>
        <button class="btn btn-ghost btn-sm" id="logoutBtn" type="button">로그아웃</button>
      </div>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <div class="article-head">
        <span class="section-pill">Admin</span>
        <h1 class="article-title">Researcher 승인</h1>
        <p class="article-sub">Researcher 권한 신청을 승인/거절합니다. (운영자만 접근)</p>
        <div class="article-meta">
          <span id="me">로그인 확인 중...</span>
          <span id="role">role: -</span>
        </div>
      </div>

      <article class="article-card" style="max-width: 920px; margin: 0 auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <h2 style="margin:0;">대기 중 신청</h2>
          <button class="btn btn-ghost btn-sm" id="refreshBtn" type="button">새로고침</button>
        </div>

        <div id="status" style="margin-top:10px; color: rgba(234,242,255,0.75); font-size:13px;"></div>
        <div id="list" style="margin-top:14px;"></div>
      </article>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://gjmffchyvthiwwhlwyam.supabase.co";
    const SUPABASE_KEY = "sb_publishable_U3s5fUx3Bm8TMs70FJawVA_aoCw7GOO";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const $ = (s) => document.querySelector(s);
    const meEl = $("#me");
    const roleEl = $("#role");
    const statusEl = $("#status");
    const listEl = $("#list");
    const refreshBtn = $("#refreshBtn");
    const logoutBtn = $("#logoutBtn");

    function esc(str){
      return (str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setStatus(msg){ statusEl.textContent = msg; }

    async function requireOperator() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        location.href = "auth.html";
        return null;
      }

      meEl.textContent = user.email || "로그인됨";

      const { data: profile, error } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", user.id)
        .single();

      if (error) {
        setStatus("프로필(role) 확인 실패: " + error.message);
        return null;
      }

      roleEl.textContent = "role: " + (profile?.role ?? "-");

      if (profile?.role !== "operator") {
        setStatus("접근 불가: 운영자(operator)만 볼 수 있어요.");
        listEl.innerHTML = "";
        return null;
      }

      return user;
    }

    async function loadPending() {
      setStatus("불러오는 중...");

      const { data, error } = await supabase
        .from("role_requests")
        .select("id,user_id,requested_role,status,message,created_at")
        .eq("requested_role", "researcher")
        .eq("status", "pending")
        .order("created_at", { ascending: false });

      if (error) {
        setStatus("목록 로드 실패: " + error.message);
        listEl.innerHTML = "";
        return;
      }

      if (!data || data.length === 0) {
        setStatus("대기 중 신청이 없어요.");
        listEl.innerHTML = "";
        return;
      }

      setStatus(`대기 ${data.length}건`);

      listEl.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:10px;">
          ${data.map(row => `
            <div class="cmt" style="padding:14px;">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                <div style="font-weight:700;">요청: ${esc(row.requested_role)}</div>
                <div style="opacity:0.7; font-size:12px;">${esc(new Date(row.created_at).toLocaleString())}</div>
              </div>
              <div style="margin-top:8px; opacity:0.85; font-size:13px;">
                user_id: <span style="opacity:0.9;">${esc(row.user_id)}</span>
              </div>
              ${row.message ? `<div style="margin-top:8px; opacity:0.8; font-size:13px;">메시지: ${esc(row.message)}</div>` : ""}

              <div style="margin-top:12px; display:flex; gap:8px;">
                <button class="btn btn-primary btn-sm" data-action="approve" data-id="${row.id}">승인</button>
                <button class="btn btn-ghost btn-sm" data-action="reject" data-id="${row.id}">거절</button>
              </div>
            </div>
          `).join("")}
        </div>
      `;

      listEl.querySelectorAll("[data-action='approve']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const ok = confirm("승인할까요? (profiles.role이 researcher로 바뀝니다)");
          if (!ok) return;

          const { error } = await supabase.rpc("approve_researcher_request", { req_id: id });
          if (error) {
            alert("승인 실패: " + error.message);
            return;
          }
          await loadPending();
        });
      });

      listEl.querySelectorAll("[data-action='reject']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const ok = confirm("거절할까요?");
          if (!ok) return;

          const { error } = await supabase.rpc("reject_researcher_request", { req_id: id });
          if (error) {
            alert("거절 실패: " + error.message);
            return;
          }
          await loadPending();
        });
      });
    }

    async function logout() {
      await supabase.auth.signOut();
      location.href = "index.html";
    }

    // init
    const user = await requireOperator();
    if (user) await loadPending();

    refreshBtn.addEventListener("click", loadPending);
    logoutBtn.addEventListener("click", logout);
  </script>
</body>
</html>
